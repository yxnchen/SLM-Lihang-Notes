# 条件随机场

[TOC]



> - **条件随机场**（conditional random field，CRF）是给定一组输入随机变量条件下，另一组输出随机变量的条件概率分布模型；
> - 特点是假设输出随机变量构成**马尔可夫随机场**；
> - 条件随机场可以用于不同的预测问题，本章讨论在标注问题的应用，即**线性链**（linear chain）条件随机场；
> - 上述问题变成由输入序列对输出序列预测的<u>*判别模型*</u>，形式为**对数线性模型**，学习方法是极大似然估计或正则化的极大似然估计；

## 11.1 概率无向图模型

> **概率无向图模型**（probabilistic undirected graphical model）又称为**马尔可夫随机场**（Markov random field），是一个可以由无向图表示的<u>*联合概率分布*</u>

### 11.1.1 模型定义

- **图**（graph）是由结点（node）和连接结点的边（edge）组成的集合，结点和边分布记作$v$和$e$，因此集合分别记作$V$和$E$，图记作$G=(V,E)$；
- **概率图模型**（probabilistic graphical model）是由图表示的概率分布，设有联合概率分布$P(Y)$，$Y\in \mathcal{Y}$是一组随机变量，由无向图$G=(V,E)$表示概率分布$P(Y)$，即在图$G$中，结点$v\in V$表示一个随机变量$Y_v$，$Y=(Y_v)_{v\in V}$；边$e\in E$表示随机变量之间的概率依赖关系；
- 给定一个联合概率分布$P(Y)$，和表示它的无向图$G$，定义无向图表示的随机变量之间可能存在的属性：
    - **成对马尔可夫性**（pairwise Markov property）：设$u$和$v$是无向图中任意两个没有边连接的结点，分别对应随机变量$Y_u$和$Y_v$，其他所有结点为$O$，对应随机变量组是$Y_O$；成对马尔可夫性是指给定随机变量组$Y_O$的条件下，随机变量$Y_u$和$Y_v$是条件独立的，即
    $$
    P(Y_u,Y_v|Y_O)=P(Y_u|Y_O)P(Y_v|Y_O)
    $$
    - **局部马尔可夫性**（local Markov property）：设$v\in V$是无向图中任意一个结点，对应随机变量$Y_v$，$W$是与$v$有边连接的所有结点，对应随机变量组是$Y_W$，$O$是$v,W$以外的其他所有结点，对应随机变量组是$Y_O$；局部马尔可夫性是指在给定随机变量组$Y_W$的条件下随机变量$Y_v$与随机变量组$Y_O$是独立的，即
    $$
    P(Y_v,Y_O|Y_W)=P(Y_v|Y_W)P(Y_O|Y_W)
    $$
    在$P(Y_O|Y_W)>0$时，等价地
    $$
    P(Y_v|Y_W)=P(Y_v|Y_W,Y_O)
    $$
    ![](./graphics/local-Markov-property.png)
    - **全局马尔可夫性**（global Markov property）：设结点集合$A,B$是在无向图$G$中被结点集合$C$分开的任意结点集合，分别对应的随机变量组是$Y_A,Y_B,Y_C$；全局马尔可夫性是指给定随机变量组$Y_C$条件下，随机变量组$Y_A$和$Y_B$是条件独立的，即
    $$
    P(Y_A,Y_B|Y_C)=P(Y_A|Y_C)P(Y_B|Y_C)
    $$
    ![](./graphics/global-Markov-property.png)

    - 上述三个定义是等价的；

- **概率无向图模型**定义：设有联合概率分布$P(Y)$，由无向图$G=(V,E)$表示，在图$G$中，结点表示随机变量，边表示随机变量之间的依赖关系；如果联合概率分布$P(Y)​$满足<u>*成对、局部或全局马尔可夫性*</u>，就称此联合概率分布为概率无向图模型，或马尔可夫随机场；

- 更加关注的问题是如何求其联合概率分布，如果可以将整体的联合概率写成若干子联合概率乘积的形式，就便于模型的学习与计算；

### 11.1.2 概率无向图模型的因子分解

- **团与最大团**：无向图$G$中任何两个结点均有边连接的结点集称为团（clique），若$C$是无向图的一个团，并且不能再加进任何一个$G$的结点使其成为一个更大的团，则称$C$为最大团（maximal clique）；
- **概率无向图模型的因子分解**（factorization）：将概率无向图模型的联合概率分布表示为其最大团上的随机变量的函数的乘积形式的操作；
- 给定概率无向图模型及其无向图$G$，$C$为$G$上的最大团，对应的随机变量组是$Y_C$，那么概率无向图模型的联合概率分布$P(Y)$可写作图中所有最大团$C$上的函数$\Psi_C(Y_C)$的乘积的形式，即
$$
P(Y)=\frac{1}{Z}\prod_{C}\Psi_C(Y_C)
$$
其中$Z$是归一化因子（normalization factor），保证$P(Y)$构成一个概率分布：
$$
Z=\sum_{Y}\prod_{C}\Psi_C(Y_C)
$$
函数$\Psi_C(Y_C)$称为**势函数**（potential function），且要求势函数是严格正的，通常定义为指数函数：
$$
\Psi_C(Y_C)=\exp \{-E(Y_C)\}
$$

- **Hammersley-Clifford定理**：概率无向图模型的联合概率分布可以表示为
$$
P(Y)=\frac{1}{Z}\prod_{C}\Psi_C(Y_C) \\
Z=\sum_{Y}\prod_{C}\Psi_C(Y_C)
$$
其中$C$是无向图的最大团，$\Psi_C(Y_C)$是$C$上定义的严格正函数，乘积是在无向图的所有最大团上进行；

## 11.2 条件随机场的定义与形式
### 11.2.1 条件随机场的定义
- **条件随机场**（conditional random field）是给定随机变量$X$的条件下，随机变量$Y$的马尔可夫随机场；
- **条件随机场定义**：设$X$和$Y$是随机变量，$P(Y|X)$是在给定$X$的条件下$Y$的条件概率分布，若随机变量$Y$构成一个由无向图$G=(V,E)$表示的马尔可夫随机场，则
$$
P(Y_v|X,Y_w,w \neq v)=P(Y_v|X,Y_w,w\sim v)
$$
对于任意结点$v$成立，则称条件概率分布$P(Y|X)$为条件随机场；其中$w\sim v$表示在图$G$中与结点$V$有边连接的所有结点$W$，$w \neq v$表示结点$V$以外的所有结点；
- 上述定义并没有要求$X$和$Y$具有相同的结构，下面主要讨论$X$和$Y$有相同的图结构，即考虑线性链的情况
$$
G=(V=(1,2,\dots,n), E={(i,i+1)}), \quad i=1,2,\dots,n-1
$$
此时$X=(X_1,X_2,\cdots,X_n)$，$Y=(Y_1,Y_2,\cdots,Y_n)$，最大团是相邻两个结点的集合；
- 下图分别是“线性链条件随机场”和“X和Y具有相同的图结构的线性链条件随机场”的示意图
![](./graphics/linear-chain-CRF.png)
![](./graphics/linear-chain-CRF-XY.png)

- **线性链条件随机场**（linear chain conditional random field）可以用于标注问题，这时在条件概率模型$P(Y|X)$中，$Y$是输出变量，表示标记序列，$X$是输入变量，表示需要标注的观测序列；
- **线性链条件随机场定义**：设$X=(X_1,X_2,\cdots,X_n)$，$Y=(Y_1,Y_2,\cdots,Y_n)$均为线性链表示的随机变量序列，若在给定随机变量序列$X$的条件下，随机变量序列$Y$的条件概率分布$P(Y|X)$构成条件随机场，即满足马尔可夫性
$$
P(Y_i|X,Y_1,\cdots,Y_{i-1},Y_{i+1},\cdots,Y_{n})=P(Y_i|X,Y_{i-1},Y_{i+1}), \\
i=1,2,\dots,n (在i=1和n时只考虑单边)
$$
则称$P(Y|X)$为线性链条件随机场；

### 11.2.2 条件随机场的参数化形式
- **线性链条件随机场的参数化形式**定理：设$P(Y|X)$为线性链条件随机场，则在随机变量$X$取值为$x$的条件下，随机变量$Y$取值为$y$的条件概率具有如下形式
$$
P(y|x)=\frac{1}{Z(x)}\exp\left(\sum_{i,k}\lambda_kt_k(y_{i-1},y_i,x,i)+\sum_{i,l}\mu_ls_l(y_i,x,i)\right)
$$
其中
$$
Z(x)=\sum_{y}\exp\left(\sum_{i,k}\lambda_kt_k(y_{i-1},y_i,x,i)+\sum_{i,l}\mu_ls_l(y_i,x,i)\right)
$$
式中，$t_k$和$s_l$是特征函数，$\lambda_k$和$\mu_l$是对应的权重，$Z(x)$是归一化因子，求和是在所有可能输出序列上进行；
- 上式中的$t_k$是定义在边上的转移函数，称为转移特征，依赖于当前和前一个位置；$s_l$是定义在结点上的特征函数，称为状态特征，依赖于当前位置；两者都依赖于位置，是局部特征函数；
- 通常特征函数$t_k$和$s_l$取值为1（当满足特征条件时），否则为0；
- 线性链条件随机场也是**对数线性模型**（log linear model）；

### 11.2.3 条件随机场的简化形式
- 在条件随机场中，同一特征在各个位置都有定义，可以对统一特征在各个位置求和，将局部特征函数转化为一个全局的特征函数，这时条件随机场就可以写成权值向量和特征向量的内积的形式；
- 设有$K_1$个转移特征，$K_2$个状态特征，$K=K_1+K_2$，记
$$
f_k(y_{i-1},y_i,x,i)
=\left\{
\begin{aligned}
t_k(y_{i-1},y_i,x,i), &\quad k=1,2,\dots,K_1 \\
s_l(y_i,x,i), &\quad  k=K_1+l; l=1,2,\dots,K_2 
\end{aligned}
\right.
$$
- 然后对转移与状态特征在各个位置$i$求和，得到
$$
f_k(y,x)=\sum_{i=1}^{n}f_k(y_{i-1},y_i,x,i),\quad k=1,2,\dots,K
$$
- 用$w_k$表示特征$f_k(y,x)$的权值，即
$$
w_k=\left\{
\begin{aligned}
\lambda_k, &\quad k=1,2,\dots,K_1 \\
\mu_l, &\quad  k=K_1+l; l=1,2,\dots,K_2 
\end{aligned}
\right.
$$
- 因此条件随机场就可以表示为
$$
\begin{aligned}
P(y|x)&=\frac{1}{Z(x)}\exp\sum_{k=1}^{K}w_kf_k(y,x) \\
Z(x) &= \sum_{y}\exp\sum_{k=1}^{K}w_kf_k(y,x)
\end{aligned}
$$
- 若以$w$表示权值向量，即$w=(w_1,w_2,\dots,w_K)^T$，以$F(y,x)$表示全局特征向量，即$F(y,x)=(f_1(y,x),f_2(y,x),\dots,f_K(y,x))^T$，则条件随机场可以写成向量内积的形式：
$$
\begin{aligned}
P_w(y|x)&=\frac{\exp(w\cdot F(y,x))}{Z_w(x)} \\
Z_w(x) &=\sum_{y}\exp(w\cdot F(y,x)) 
\end{aligned}
$$

### 11.2.4 条件随机场的矩阵形式
